import{a as R,d as l,s as N}from"./firebase-B3bAttLw.js";import{createUserWithEmailAndPassword as B}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{ref as m,set as g,get as $}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";import{ref as I,uploadBytes as j}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";function F(){const n=new Date,a=new Date(n.toLocaleString("en-US",{timeZone:"Africa/Johannesburg"})),t=a.getFullYear(),r=String(a.getMonth()+1).padStart(2,"0");return`${t}-${r}`}function e(n){const a=document.getElementById(n);return a?a.value:""}document.getElementById("applicationForm").addEventListener("submit",async n=>{n.preventDefault();const a=n.target.querySelector('button[type="submit"]');a.disabled=!0,a.textContent="Submitting...";try{const t={firstName:e("firstName"),lastName:e("lastName"),idNumber:e("idNumber"),race:e("race"),email:e("email"),phone:e("phone"),address:{line1:e("addressLine1"),line2:e("addressLine2"),city:e("city"),province:e("province"),postalCode:e("postalCode"),country:e("country")},highestGrade:e("highestGrade"),attendanceType:e("attendanceType"),subjects:L(),guardian:{firstName:e("guardianFirstName"),lastName:e("guardianLastName"),idNumber:e("guardianIdNumber"),race:e("guardianRace"),phone:e("guardianPhone"),email:e("guardianEmail"),employmentStatus:e("guardianEmploymentStatus")},declaration:{name:e("declarationName"),signedAt:e("signedAt"),date:e("declarationDate"),guardianSignature:e("guardianSignature"),studentSignature:e("studentSignature")},payment:{registrationFee:"pending"},monthlyPayment:{month:F(),status:"pending"},status:"pending",applicationDate:new Date().toISOString(),lastUpdated:new Date().toISOString()},r=e("password"),s=e("confirmPassword");if(r!==s){b("Passwords do not match!","error"),a.disabled=!1,a.textContent="Submit Application";return}const u=(await B(R,t.email,r)).user,i="ESS"+Date.now()+Math.random().toString(36).substr(2,5).toUpperCase();t.studentCode=i,t.uid=u.uid;const o=m(l,`application/pending/${u.uid}`);await g(o,t);try{const c=await P(u.uid),S=await x(t);c&&c.documents&&console.log("Documents uploaded:",c.documents)}catch(c){console.error("Document upload failed:",c),b("Application saved BUT document upload failed: "+c.message,"error")}try{const c=m(l,"teachers"),S=await $(c);if(S.exists()){const C=S.val(),v=t.subjects;for(const w in C){const f=C[w],h=f?.teachingInfo?.subjects||f?.subjects||[];if(!h||h.length===0)continue;const D=h.map(d=>String(d).trim().toLowerCase()).filter(Boolean),E=v.map(d=>String(d).trim().toLowerCase()),y=D.filter(d=>E.includes(d)).map(d=>h.find(A=>String(A).trim().toLowerCase()===d)||d);y.length>0&&(await g(m(l,`teacher_students/${w}/${u.uid}`),{subjects:y,studentName:t.firstName+" "+t.lastName}),await g(m(l,`student_teachers/${u.uid}/${w}`),{subjects:y,teacherName:f.firstName+" "+f.lastName}))}}}catch(c){console.error("Error matching teachers:",c)}b("Application submitted successfully! Your student code: "+i,"success"),setTimeout(()=>{window.location.href="login.html"},3e3)}catch(t){console.error("Error submitting application:",t),b("Error submitting application: "+t.message,"error"),a.disabled=!1,a.textContent="Submit Application"}});function b(n,a="info"){const t=document.getElementById("toast");t.textContent=n,t.className="toast "+a,t.style.display="block",setTimeout(()=>{t.style.display="none"},5e3)}function L(){const n=document.querySelectorAll(".subject-checkbox:checked");let a=Array.from(n).map(r=>r.value);const t=document.getElementById("additionalSubjects");if(t){const r=t.value.trim();r.length>0&&(a=a.concat(r.split(",").map(s=>s.trim()).filter(s=>s.length>0)))}return a}async function x(n){if(!n||!n.uid)return[];const a=n.uid;if(!n.subjects||n.subjects.length===0)return[];const t=`${n.firstName||""} ${n.lastName||""}`.trim(),r=n.subjects.map(i=>String(i).trim().toLowerCase()).filter(i=>i.length>0),s=await $(m(l,"courses"));if(!s.exists())return[];const p=s.val();let u=[];for(const i in p){const o=p[i],c=String(o.subject||o.name||"").trim().toLowerCase();c&&r.includes(c)&&(await g(m(l,`enrollments/${a}/${i}`),{studentId:a,studentName:t,courseId:i,courseName:o.name||o.subject,status:"active",enrolledAt:new Date().toISOString()}),u.push(o.name||o.subject),o.teacherId&&(await g(m(l,`teacher_students/${o.teacherId}/${a}`),{subjects:[o.subject||o.name],studentName:t}),await g(m(l,`student_teachers/${a}/${o.teacherId}`),{subjects:[o.subject||o.name],teacherName:o.teacherName||""})))}return u}async function P(n){const a=document.getElementById("previousResults").files[0],t=document.getElementById("studentIdCopy").files[0],r=document.getElementById("guardianIdCopy").files[0];if(!a||!t||!r)return console.warn("One or more required files missing. Skipping document upload."),null;try{const s={},p=I(N,`application/${n}/previousResults-${Date.now()}`);await j(p,a),s.previousResults=p.fullPath;const u=I(N,`application/${n}/studentIdCopy-${Date.now()}`);await j(u,t),s.studentIdCopy=u.fullPath;const i=I(N,`application/${n}/guardianIdCopy-${Date.now()}`);return await j(i,r),s.guardianIdCopy=i.fullPath,{documents:s}}catch(s){throw console.error("Document upload failed:",s),new Error("Firebase storage upload failed: "+s.message)}}
