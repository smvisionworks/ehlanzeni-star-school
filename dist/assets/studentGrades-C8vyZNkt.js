import{a as S,d as u}from"./firebase-B3bAttLw.js";import{onAuthStateChanged as F}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{ref as g,get as m}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";import"./global-floating-logout-Em6X96d7.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";let N=null,E=null,T=[];document.addEventListener("DOMContentLoaded",()=>{F(S,async t=>{if(!t){p("Please log in to access this page","error"),setTimeout(()=>window.location.href="../landing/login.html",3e3);return}N=t,await I(t.uid),await B()})});async function I(t){try{const n=g(u,`application/pending/${t}`),e=await m(n);if(e.exists()){const s=e.val();return s.status==="approved"&&s.payment&&s.payment.registrationFee==="paid"?s.monthlyPayment&&s.monthlyPayment.status==="pending"?(console.log("Monthly payment pending for month:",s.monthlyPayment.month),window.location.href="../students/payment-pending.html",!1):(E=s,!0):(p("Your application is not yet fully approved","error"),setTimeout(()=>window.location.href="../unverifiedstudents/student-dashboard.html",3e3),!1)}return p("No complete application found","error"),setTimeout(()=>window.location.href="../landing/login.html",3e3),!1}catch(n){return console.error("Error checking user status:",n),p("Error verifying application status","error"),!1}}async function B(){if(!E){console.error("No user data available");return}const t=`${E.firstName} ${E.lastName}`;document.getElementById("studentName").textContent=t,await G(N.uid),D()}function D(){const t=document.getElementById("courseFilter"),n=document.getElementById("searchAssignments");t&&t.addEventListener("change",C),n&&n.addEventListener("input",C)}async function G(t){const n=document.getElementById("grades-container");n.innerHTML='<div class="no-grades">Loading grades...</div>';try{console.log("Fetching grades for student:",t);const e=g(u,`enrollments/${t}`),s=await m(e);if(!s.exists()){console.log("No active enrollments found"),n.innerHTML='<div class="no-grades">You are not enrolled in any courses with grades.</div>';return}const r=s.val(),o=Object.keys(r).filter(a=>r[a].status==="active");if(o.length===0){n.innerHTML='<div class="no-grades">You are not enrolled in any courses with grades.</div>';return}const f=g(u,"submissions"),c=await m(f);if(!c.exists()){n.innerHTML='<div class="no-grades">No graded assignments available yet.</div>';return}let d={};if(c.forEach(a=>{const y=a.key,w=a.val();w[t]&&(d[y]=w[t])}),Object.keys(d).length===0){n.innerHTML='<div class="no-grades">No graded assignments available yet.</div>';return}const $=g(u,"resources"),l=await m($);let i={};if(l.exists()){const a=l.val();Object.entries(a).forEach(([y,w])=>{w.resourceType==="assignment"&&(i[y]=w)})}const L=g(u,"courses"),h=await m(L),k=h.exists()?h.val():{},v=Object.entries(d).map(([a,y])=>({assignmentId:a,...y,assignment:i[a],course:i[a]?k[i[a].courseId]:null})).filter(a=>a.grade!==null&&a.grade!==void 0&&a.assignment&&o.includes(a.assignment.courseId));if(console.log("Graded submissions:",v),v.length===0){n.innerHTML='<div class="no-grades">No graded assignments available yet.</div>';return}T=v,H(v),A(v)}catch(e){console.error("Error fetching grades:",e),n.innerHTML='<div class="no-grades">Error loading grades. Please try again later.</div>',p("Error loading grades: "+e.message,"error")}}function H(t){const n=document.getElementById("courseFilter");if(!n)return;const e=[...new Set(t.map(s=>s.course?.name).filter(Boolean))];n.innerHTML='<option value="all">All Courses</option>',e.forEach(s=>{const r=document.createElement("option");r.value=s,r.textContent=s,n.appendChild(r)})}function A(t){const n=document.getElementById("grades-container");if(t.length===0){n.innerHTML='<div class="no-grades">No graded assignments match your filters.</div>';return}n.innerHTML="",t.forEach(e=>{e.assignment,e.course;const s=`${e.grade}%`,r=M(e.grade),o=document.createElement("div");o.className=`grade-card ${r}`,o.innerHTML=`
            <h3>${e.assignment?.title||"N/A"}</h3>
            <p><strong>Subject:</strong> ${e.course?.name||"N/A"}</p>
            <p><strong>Assignment Type:</strong> ${e.assignment?.type||"N/A"}</p>
            <p><strong>Grade:</strong> <span class="grade-value">${s}</span></p>
            <div class="grade-meta">
                <span class="submission-date">Submitted: ${b(e.submittedAt)}</span>
                ${e.gradedAt?`<span class="graded-date">Graded: ${b(e.gradedAt)}</span>`:""}
            </div>
            <div class="grade-actions">
                <a href="#" class="view" onclick="viewSubmissionDetails('${e.assignmentId}', '${e.assignment?.title.replace(/'/g,"\\'")}', '${e.grade}', '${(e.feedback||"").replace(/'/g,"\\'")}', '${(e.course?.name||"N/A").replace(/'/g,"\\'")}', '${e.assignment?.type||"N/A"}', '${e.submittedAt}', '${e.gradedAt||""}')">
                    View Details
                </a>
            </div>
        `,n.appendChild(o)})}function M(t){return t>=80?"grade-excellent":t>=70?"grade-good":t>=50?"grade-average":"grade-poor"}function C(){const t=document.getElementById("courseFilter"),n=document.getElementById("searchAssignments"),e=t?t.value:"all",s=n?n.value.toLowerCase():"";let r=T.filter(o=>{const f=e==="all"||o.course?.name===e,c=!s||o.assignment.title.toLowerCase().includes(s)||o.course?.name&&o.course.name.toLowerCase().includes(s);return f&&c});A(r)}async function x(t,n,e,s,r,o,f,c){try{const d=g(u,`submissions/${t}`),$=await m(d);let l=s,i=e;if($.exists()){const h=$.val();l=h.feedback||s,i=h.grade||e}const L=`
            <h2>${n}</h2>
            <div class="submission-details">
                <p><strong>Subject:</strong> ${r}</p>
                <p><strong>Assignment Type:</strong> ${o}</p>
                <p><strong>Grade:</strong> <span class="grade-value ${M(parseFloat(i))}">${i}%</span></p>
                <p><strong>Submitted:</strong> ${b(f)}</p>
                ${c?`<p><strong>Graded:</strong> ${b(c)}</p>`:""}
            </div>
            <hr>
            <div class="feedback-section">
                <h3>Feedback</h3>
                <div class="feedback-content">
                    ${l&&l.trim()!==""?`<p style="white-space: pre-wrap;">${l}</p>`:"<p><em>No feedback provided for this submission.</em></p>"}
                </div>
            </div>
        `;document.getElementById("feedbackContent").innerHTML=L,document.getElementById("feedbackModal").classList.add("show")}catch(d){console.error("Error fetching submission details:",d),p("Failed to load submission details.","error")}}function j(){document.getElementById("feedbackModal").classList.remove("show")}function p(t,n="success"){const e=document.getElementById("toast");e.textContent=t,e.className=`toast ${n} show`,setTimeout(()=>e.className=`toast ${n}`,3e3)}function b(t){if(!t)return"N/A";try{return new Date(t).toLocaleDateString("en-ZA",{day:"numeric",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return console.error("Error formatting date:",n),"Invalid Date"}}window.viewSubmissionDetails=x;window.closeFeedbackModal=j;window.filterGrades=C;
