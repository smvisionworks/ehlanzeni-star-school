import{a as I,d as h}from"./firebase-B3bAttLw.js";import{onAuthStateChanged as E}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{ref as m,get as p,set as k}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";import"./global-floating-logout-Em6X96d7.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";let w,b,C,y=null,u=null;function S(o={}){const{minWidth:e=768,redirectUrl:n="../landing/use-bigger-screen.html",showAlert:s=!0}=o;let r=!1;function a(){if(r)return;const t=window.innerWidth,l=window.innerHeight;(t<e||l<500)&&(r=!0,console.warn("Blocked small screen:",{width:t,height:l}),s&&alert(`This teacher dashboard is not supported on small screens.

Please use a tablet or laptop.`),window.location.href=n)}a(),window.addEventListener("resize",a),window.addEventListener("orientationchange",a)}document.addEventListener("DOMContentLoaded",()=>{S({minWidth:768,redirectUrl:"../landing/unsupported-device.html",showAlert:!0}),E(I,async o=>{if(!o){g("Please log in to access this page"),setTimeout(()=>window.location.href="../landing/login.html",3e3);return}y=o,await v(o.uid),await D()})});async function v(o){try{const e=m(h,`teachers/${o}`),n=await p(e);return n.exists()?(u=n.val(),console.log("Teacher data loaded:",u),u.status==="pending"?(g("Your teacher account is pending admin approval. You will be notified once approved. Please check back later."),setTimeout(()=>window.location.href="../landing/pending-admin-aproval.html",1e3),!1):!0):(g("Teacher profile not found. Please register as a teacher first."),setTimeout(()=>window.location.href="../landing/login.html",3e3),!1)}catch(e){return console.error("Error checking teacher status:",e),g("Error verifying teacher status"),!1}}async function D(){if(W(),!u){g("No teacher data available");return}const o=`${u.personalInfo.firstName} ${u.personalInfo.lastName}`;document.getElementById("teacherName").textContent=o,document.getElementById("welcomeText").textContent=`Welcome back, ${u.personalInfo.firstName}!`;try{const e=u.teachingInfo?.subjects||[];if(console.log("Teacher subjects:",e),e.length===0){g("No subjects found in your teacher profile. Please update your profile.");return}const n=await x(e);if(console.log("Teacher courses after ensuring:",n),n.length===0){g("No courses could be created or found for your subjects.");return}const s=n.map(f=>f.id),r=new Date,a=new Date(r.setDate(r.getDate()-r.getDay()+(r.getDay()===0?-6:1))),t=new Date(r.setDate(a.getDate()+6));a.setHours(0,0,0,0),t.setHours(23,59,59,999);const l=new Date().toISOString().split("T")[0];console.log("Week range:",a.toISOString(),"to",t.toISOString()),console.log("Course IDs for teacher:",s);let i=0,c=0,d=0;i=await N(s,l,t),c=await $(y.uid,a,t),d=await T(s,a,t),j(i,c,d),R(i,c,d),M(),O()}catch(e){console.error("Error initializing dashboard:",e),g("Error loading dashboard data: "+e.message)}}async function x(o){try{const e=m(h,"courses"),n=await p(e),s=n.exists()?n.val():{};console.log("Existing courses in database:",s);const r=[],a=[];for(const t of o){if(t==="N/A"||!t.trim())continue;const l=Object.entries(s).find(([i,c])=>c.teacherId===y.uid&&(c.name===t||c.subject===t));if(l)r.push({id:l[0],...l[1]}),console.log(`Found existing course for ${t}:`,l[0]);else{const i=B(t),c={name:t,description:`${t} - Course for ${u.personalInfo.firstName} ${u.personalInfo.lastName}`,code:A(t),teacherId:y.uid,teacherName:`${u.personalInfo.firstName} ${u.personalInfo.lastName}`,createdAt:new Date().toISOString(),status:"active",subject:t},d=m(h,`courses/${i}`);a.push(k(d,c)),r.push({id:i,...c}),console.log(`Creating new course for ${t}:`,i)}}return a.length>0&&(await Promise.all(a),console.log(`Created ${a.length} new courses`)),console.log("Final teacher courses:",r),r}catch(e){throw console.error("Error ensuring teacher courses:",e),e}}function B(o){return`course-${o.replace(/[^a-zA-Z0-9]/g,"-").toLowerCase()}-${y.uid}-${Date.now()}`}function A(o){const e=o.substring(0,3).toUpperCase().replace(/[^A-Z]/g,""),n=Math.floor(100+Math.random()*900);return`${e}${n}`}async function N(o,e,n){try{const s=m(h,"calendar_events"),r=await p(s);if(!r.exists())return console.log("No calendar events found in database"),0;const a=r.val();let t=[];Object.values(a).forEach(c=>{c&&typeof c=="object"&&(t=t.concat(Object.values(c)))}),console.log("All calendar events (flattened):",t);const l=n.toISOString().split("T")[0],i=t.filter(c=>{const d=o.includes(c.courseId),f=c.date>=e&&c.date<=l;return d&&f&&console.log("Found upcoming event:",c),d&&f});return console.log("Upcoming classes fetched:",i.length,i),i.length}catch(s){return console.error("Error fetching upcoming classes:",s),0}}async function $(o,e,n){try{const s=m(h,"resources"),r=await p(s);if(!r.exists())return console.log("No resources found in database"),0;const a=r.val();console.log("All resources (for assignments):",a);const t=Object.values(a).filter(l=>{const i=l.resourceType==="assignment",c=l.teacherId===o,d=new Date(l.createdAt||l.created_at),f=d>=e&&d<=n;return i&&c&&f});return console.log("Weekly assignments fetched (from resources):",t.length,t),t.length}catch(s){return console.error("Error fetching weekly assignments:",s),0}}async function T(o,e,n){try{const s=m(h,"resources"),r=await p(s);if(!r.exists())return console.log("No resources found in database"),0;const a=r.val();console.log("All resources:",a);const t=Object.values(a).filter(l=>{const i=o.includes(l.courseId),c=new Date(l.createdAt||l.created_at),d=c>=e&&c<=n;return i&&d});return console.log("Weekly resources fetched:",t.length,t),t.length}catch(s){return console.error("Error fetching weekly resources:",s),0}}function j(o,e,n){document.getElementById("classesCount").textContent=o,document.getElementById("assignmentsCount").textContent=e,document.getElementById("resourcesCount").textContent=n;const s=document.getElementById("classesChart");w&&w.destroy(),w=new Chart(s,{type:"doughnut",data:{labels:["Upcoming Classes","Remaining"],datasets:[{data:[o,Math.max(5-o,0)],backgroundColor:["#007bff","#d3e3f8"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom",labels:{color:"#003087",font:{size:14}}},tooltip:{enabled:!0,bodyFont:{size:14}},datalabels:{color:"#fff",font:{weight:"bold",size:16},formatter:t=>t>0?t:""}}}});const r=document.getElementById("assignmentsChart");b&&b.destroy(),b=new Chart(r,{type:"bar",data:{labels:["Assignments Created"],datasets:[{data:[e],backgroundColor:e>0?["#007bff"]:["#d3e3f8"],borderColor:"#fff",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!0,bodyFont:{size:14}},datalabels:{color:"#fff",font:{weight:"bold",size:16},anchor:"end",align:"top"}},scales:{y:{beginAtZero:!0,max:Math.max(e+2,5),ticks:{color:"#003087",font:{size:12}}}}}});const a=document.getElementById("resourcesChart");C&&C.destroy(),C=new Chart(a,{type:"bar",data:{labels:["Resources"],datasets:[{data:[n],backgroundColor:n>0?["#007bff"]:["#d3e3f8"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!0,bodyFont:{size:14}}},scales:{y:{beginAtZero:!0,max:Math.max(n+2,5),ticks:{color:"#003087",font:{size:12}}}}}})}function R(o,e,n){try{const s=Math.min(o*10+e*15+n*10,100);document.getElementById("scoreValue").textContent=Math.round(s),document.getElementById("weeklyScore").style.display="block"}catch(s){console.error("Weekly score calculation error:",s),document.getElementById("weeklyScore").style.display="none"}}function g(o){const e=document.getElementById("errorMessage");e.textContent=o,e.style.display="block",document.getElementById("loadingMessage").style.display="none",document.getElementById("cardContainer").style.display="none",document.getElementById("weeklyScore").style.display="none",console.error("Error:",o)}function W(){document.getElementById("loadingMessage").style.display="flex",document.getElementById("cardContainer").style.display="none",document.getElementById("weeklyScore").style.display="none"}function M(){document.getElementById("loadingMessage").style.display="none"}function O(){document.getElementById("cardContainer").style.display="grid",document.getElementById("weeklyScore").style.display="block"}
