import{a as f,d as v}from"./firebase-B3bAttLw.js";import{onAuthStateChanged as h,signOut as b}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{ref as E,onValue as I,update as B}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";console.log("Dashboard JS loaded");let d=null,g=null;document.addEventListener("DOMContentLoaded",()=>{h(f,async e=>{if(!e){window.location.href="../landing/login.html";return}g=e.uid,await L(e.uid),A(),w()})});document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("sidebar"),t=document.getElementById("sidebar-toggle"),n=document.getElementById("sidebar-overlay"),i=document.querySelectorAll(".nav-item");if(!e||!t||!n)return;const a=()=>{e.classList.remove("-translate-x-full"),n.classList.remove("hidden"),document.documentElement.classList.add("no-scroll"),e.setAttribute("aria-hidden","false")},o=()=>{e.classList.add("-translate-x-full"),n.classList.add("hidden"),document.documentElement.classList.remove("no-scroll"),e.setAttribute("aria-hidden","true")};t.addEventListener("click",s=>{s.stopPropagation(),e.classList.contains("-translate-x-full")?a():o()}),n.addEventListener("click",o),i.forEach(s=>{s.addEventListener("click",()=>{window.innerWidth<768&&o()})});const l=()=>{window.innerWidth>=768?(e.classList.remove("-translate-x-full"),n.classList.add("hidden"),document.documentElement.classList.remove("no-scroll"),e.setAttribute("aria-hidden","false")):(e.classList.add("-translate-x-full"),e.setAttribute("aria-hidden","true"))};window.addEventListener("resize",l),l()});async function L(e){try{console.log("Loading application data for UID:",e);const t=E(v,`application/pending/${e}`);I(t,n=>{n.exists()?(d=n.val(),console.log("Application data loaded:",d),x(d)):(console.log("No application data found for UID:",e),r("No application data found. Please submit an application first.","error"),setTimeout(()=>{window.location.href="apply.html"},3e3))},n=>{console.error("Error loading application data:",n),r("Error loading application data: "+n.message,"error")})}catch(t){console.error("Error setting up application listener:",t),r("Error loading application data: "+t.message,"error")}}function x(e){if(console.log("Populating dashboard with data:",e),!!e){if(document.getElementById("student-name").textContent=`${e.firstName||""} ${e.lastName||""}`,document.getElementById("student-code").innerHTML=`<i class="fas fa-id-card text-accent"></i><span>Code: ${e.studentCode||"N/A"}</span>`,N(e.status||"pending"),S(e.status||"pending",e),P(e),e.applicationDate){const t=new Date(e.applicationDate).toLocaleDateString("en-ZA",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});document.getElementById("submission-date").textContent=t}D(e)}}function N(e){const t=document.getElementById("application-status"),n=document.getElementById("status-badge"),i=document.getElementById("status-title");if(!t||!n||!i)return;t.className=`status-${e.toLowerCase()} status-badge inline-flex items-center space-x-2`,n.className=`status-badge ${e.toLowerCase()} text-lg px-6 py-2`;const a=e.charAt(0).toUpperCase()+e.slice(1);switch(t.innerHTML=`<i class="fas fa-clock"></i><span>${a}</span>`,n.textContent=a,e.toLowerCase()){case"approved":i.textContent="Application Approved",i.nextElementSibling.textContent="Your application has been approved!";break;case"rejected":i.textContent="Application Rejected",i.nextElementSibling.textContent="Your application has been rejected.";break;default:i.textContent="Application Under Review",i.nextElementSibling.textContent="We're currently reviewing your application"}}function S(e,t){const n=document.querySelectorAll(".timeline-item"),i=document.getElementById("admin-review-status"),a=document.getElementById("payment-status"),o=document.getElementById("enrollment-status"),l=document.getElementById("admin-review-date");if(n.forEach(s=>{s.classList.remove("completed","current","pending"),s.classList.add("pending")}),n[0].classList.remove("pending"),n[0].classList.add("completed"),t&&t.applicationDate){const s=new Date(t.applicationDate).toLocaleDateString("en-ZA",{year:"numeric",month:"long",day:"numeric"});document.getElementById("submission-date-timeline").textContent=`Date: ${s}`}if(e==="pending")n[1].classList.remove("pending"),n[1].classList.add("current"),i&&(i.innerHTML='<i class="fas fa-sync-alt animate-spin"></i><span>In Progress</span>',i.className="text-blue-500 text-sm font-medium flex items-center space-x-1");else if(e==="approved"){if(n[1].classList.remove("pending"),n[1].classList.add("completed"),i&&(i.innerHTML='<i class="fas fa-check-circle"></i><span>Completed</span>',i.className="text-green-500 text-sm font-medium flex items-center space-x-1"),t&&t.approvedDate){const c=new Date(t.approvedDate).toLocaleDateString("en-ZA",{year:"numeric",month:"long",day:"numeric"});l.textContent=`Approved on: ${c}`}if(t&&t.payment&&t.payment.registrationFee==="paid"){if(n[2].classList.remove("pending"),n[2].classList.add("completed"),a&&(a.innerHTML='<i class="fas fa-check-circle"></i><span>Completed</span>',a.className="text-green-500 text-sm font-medium flex items-center space-x-1"),t.payment.registrationFeeDate){const c=new Date(t.payment.registrationFeeDate).toLocaleDateString("en-ZA",{year:"numeric",month:"long",day:"numeric"}),m=n[2].querySelector(".flex-1");if(m){const y=m.querySelector(".payment-date");y&&y.remove();const u=document.createElement("p");u.className="text-sm text-gray-500 mt-1 payment-date",u.textContent=`Paid on: ${c}`,m.appendChild(u)}}n[3].classList.remove("pending"),n[3].classList.add("completed"),o&&(o.innerHTML='<i class="fas fa-check-circle"></i><span>Completed</span>',o.className="text-green-500 text-sm font-medium flex items-center space-x-1")}else n[2].classList.remove("pending"),n[2].classList.add("current")}}function D(e){if(document.getElementById("edit-firstName").value=e.firstName||"",document.getElementById("edit-lastName").value=e.lastName||"",document.getElementById("edit-idNumber").value=e.idNumber||"",document.getElementById("edit-race").value=e.race||"",document.getElementById("edit-email").value=e.email||"",document.getElementById("edit-phone").value=e.phone||"",e.address&&(document.getElementById("edit-addressLine1").value=e.address.line1||"",document.getElementById("edit-addressLine2").value=e.address.line2||"",document.getElementById("edit-city").value=e.address.city||"",document.getElementById("edit-province").value=e.address.province||"",document.getElementById("edit-postalCode").value=e.address.postalCode||"",document.getElementById("edit-country").value=e.address.country||"South Africa"),document.getElementById("edit-highestGrade").value=e.highestGrade||"",document.getElementById("edit-attendanceType").value=e.attendanceType||"",e.subjects&&Array.isArray(e.subjects)&&(document.getElementById("edit-subjects").value=e.subjects.join(`
`)),e.guardian&&(document.getElementById("edit-guardianFirstName").value=e.guardian.firstName||"",document.getElementById("edit-guardianLastName").value=e.guardian.lastName||"",document.getElementById("edit-guardianIdNumber").value=e.guardian.idNumber||"",document.getElementById("edit-guardianRace").value=e.guardian.race||"",document.getElementById("edit-guardianEmail").value=e.guardian.email||"",document.getElementById("edit-guardianPhone").value=e.guardian.phone||"",document.getElementById("edit-guardianEmploymentStatus").value=e.guardian.employmentStatus||""),e.payment){const t=document.createElement("div");t.className="mt-6 p-4 bg-blue-50 rounded-lg",t.innerHTML=`
            <h4 class="font-semibold text-blue-800 mb-2">Payment Information</h4>
            <p class="text-sm text-blue-600">Registration Fee: <span class="font-medium">${e.payment.registrationFee||"Not Paid"}</span></p>
            ${e.payment.registrationFeeDate?`<p class="text-sm text-blue-600">Paid on: ${new Date(e.payment.registrationFeeDate).toLocaleDateString()}</p>`:""}
            ${e.payment.approvedBy?`<p class="text-sm text-blue-600">Approved by: ${e.payment.approvedBy}</p>`:""}
        `;const n=document.getElementById("status-tab"),i=n.querySelector(".payment-info");i&&i.remove(),t.classList.add("payment-info"),n.querySelector(".grid").before(t)}if(e.monthlyPayment){const t=document.createElement("div");t.className="mt-4 p-4 bg-green-50 rounded-lg",t.innerHTML=`
            <h4 class="font-semibold text-green-800 mb-2">Monthly Payment (${e.monthlyPayment.month||"N/A"})</h4>
            <p class="text-sm text-green-600">Status: <span class="font-medium">${e.monthlyPayment.status||"Pending"}</span></p>
            ${e.monthlyPayment.updatedDate?`<p class="text-sm text-green-600">Updated: ${new Date(e.monthlyPayment.updatedDate).toLocaleDateString()}</p>`:""}
        `;const n=document.getElementById("status-tab"),i=n.querySelector(".monthly-payment");i&&i.remove(),t.classList.add("monthly-payment");const a=n.querySelector(".payment-info");a?a.after(t):n.querySelector(".grid").before(t)}}function w(){const e=document.querySelectorAll(".nav-item");e.forEach(t=>{t.addEventListener("click",function(n){n.preventDefault(),e.forEach(a=>{a.classList.remove("bg-blue-600","text-white","active"),a.classList.add("text-gray-300","hover:bg-gray-700/50","hover:text-white")}),this.classList.remove("text-gray-300","hover:bg-gray-700/50","hover:text-white"),this.classList.add("bg-blue-600","text-white","active"),document.querySelectorAll(".tab-content").forEach(a=>{a.classList.remove("active")});const i=this.getAttribute("data-tab")+"-tab";document.getElementById(i).classList.add("active")})})}function A(){const e=document.getElementById("profile-form");e&&e.addEventListener("submit",a=>p(a,"profile"));const t=document.getElementById("education-form");t&&t.addEventListener("submit",a=>p(a,"education"));const n=document.getElementById("guardian-form");n&&n.addEventListener("submit",a=>p(a,"guardian"));const i=document.getElementById("logout-btn");i&&i.addEventListener("click",C)}async function p(e,t){e.preventDefault();const i=e.target.querySelector(".save-btn");if(!(!i||!g)){i.disabled=!0,i.innerHTML='<i class="fas fa-spinner fa-spin"></i><span>Saving...</span>';try{const a={};if(t==="profile")a.firstName=document.getElementById("edit-firstName").value,a.lastName=document.getElementById("edit-lastName").value,a.idNumber=document.getElementById("edit-idNumber").value,a.race=document.getElementById("edit-race").value,a.email=document.getElementById("edit-email").value,a.phone=document.getElementById("edit-phone").value,a.address={line1:document.getElementById("edit-addressLine1").value,line2:document.getElementById("edit-addressLine2").value,city:document.getElementById("edit-city").value,province:document.getElementById("edit-province").value,postalCode:document.getElementById("edit-postalCode").value,country:document.getElementById("edit-country").value};else if(t==="education"){a.highestGrade=document.getElementById("edit-highestGrade").value,a.attendanceType=document.getElementById("edit-attendanceType").value;const l=document.getElementById("edit-subjects").value;a.subjects=l.split(`
`).map(s=>s.trim()).filter(s=>s.length>0)}else t==="guardian"&&(a.guardian={firstName:document.getElementById("edit-guardianFirstName").value,lastName:document.getElementById("edit-guardianLastName").value,idNumber:document.getElementById("edit-guardianIdNumber").value,race:document.getElementById("edit-guardianRace").value,email:document.getElementById("edit-guardianEmail").value,phone:document.getElementById("edit-guardianPhone").value,employmentStatus:document.getElementById("edit-guardianEmploymentStatus").value});a.lastUpdated=new Date().toISOString();const o=E(v,`application/pending/${g}`);await B(o,a),t==="profile"||t==="education"?Object.assign(d,a):t==="guardian"&&(d.guardian=a.guardian),d.lastUpdated=a.lastUpdated,r("Changes saved successfully!","success")}catch(a){console.error("Error saving changes:",a),r("Error saving changes: "+a.message,"error")}finally{i.disabled=!1,i.innerHTML='<i class="fas fa-save"></i><span>Save Changes</span>'}}}async function C(){try{await b(f),window.location.href="../landing/login.html"}catch(e){console.error("Logout error:",e),window.location.href="../landing/login.html"}}function r(e,t="info"){const n=document.getElementById("toast");if(!n){console.error("Toast element not found");return}n.textContent=e,n.className=`toast ${t}`,n.style.display="block",setTimeout(()=>{n.style.display="none"},5e3)}function P(e){e.declaration&&(document.getElementById("declaration-name").textContent=e.declaration.name||"N/A",document.getElementById("declaration-guardian-signature").textContent=e.declaration.guardianSignature||"N/A",document.getElementById("declaration-student-signature").textContent=e.declaration.studentSignature||"N/A",document.getElementById("declaration-date").textContent=e.declaration.date||"N/A",document.getElementById("declaration-location").textContent=e.declaration.signedAt||"N/A")}
