import{a as T,d as p}from"./firebase-B3bAttLw.js";import{onAuthStateChanged as M,signOut as N}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";import{ref as f,get as h}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";import"./global-floating-logout-Em6X96d7.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";let y=null;document.addEventListener("DOMContentLoaded",()=>{M(T,async n=>{if(!n){w("Please log in to access this page","error"),setTimeout(()=>window.location.href="../landing/login.html",3e3);return}await I(n.uid),await H(n.uid),G()})});async function I(n){try{const e=f(p,`application/pending/${n}`),t=await h(e);if(t.exists()){const s=t.val();return s.status==="approved"&&s.payment&&s.payment.registrationFee==="paid"?s.monthlyPayment&&s.monthlyPayment.status==="pending"?(console.log("Monthly payment pending for month:",s.monthlyPayment.month),setTimeout(()=>window.location.href="../students/payment-pending.html",500),!1):(y=s,!0):(w("Your application is not yet fully approved","error"),setTimeout(()=>window.location.href="../unverifiedstudents/student-dashboard.html",3e3),!1)}return w("No complete application found","error"),setTimeout(()=>window.location.href="../landing/login.html",3e3),!1}catch(e){return console.error("Error checking user status:",e),w("Error verifying application status","error"),!1}}async function H(n){if(!y){console.error("No user data available");return}const e=`${y.firstName} ${y.lastName}`;document.getElementById("studentName").textContent=e,document.getElementById("welcomeName").textContent=y.firstName,await $(n),document.querySelectorAll(".loading-skeleton").forEach(t=>t.classList.remove("loading-skeleton"))}async function $(n){try{const e=await B(n);if(e.length===0){L();return}await Promise.all([C(n,e),D(n,e),x(n,e),k(n,e),S(n)])}catch(e){console.error("Error loading dashboard data:",e),w("Error loading dashboard data","error"),L()}}async function B(n){try{const e=f(p,`enrollments/${n}`),t=await h(e);if(t.exists()){const s=t.val();return Object.entries(s).filter(([c,d])=>d.status==="active").map(([c,d])=>({courseId:c,courseName:d.courseName,enrolledAt:d.enrolledAt}))}return[]}catch(e){return console.error("Error fetching enrollments:",e),[]}}async function C(n,e){const t=document.getElementById("resourcesGraph");if(t.innerHTML="",e.length===0){t.innerHTML='<p class="no-data">No active course enrollments found.</p>';return}try{const s=f(p,"resources"),a=await h(s);if(a.exists()){const c=a.val(),d=e.map(o=>o.courseId),u=Object.values(c).filter(o=>d.includes(o.courseId)&&b(o.createdAt,7)),i={};if(u.forEach(o=>{const l=o.courseName||"Unknown Course";i[l]=(i[l]||0)+1}),Object.keys(i).length>0){Object.entries(i).forEach(([r,m])=>{const g=v(r,m,"resources");t.appendChild(g)});const o=u.length,l=document.createElement("p");l.className="summary-text",l.innerHTML=`<strong>${o}</strong> new resources available across <strong>${Object.keys(i).length}</strong> courses`,t.appendChild(l)}else t.innerHTML='<p class="no-data">No new resources in the past week.</p>'}else t.innerHTML='<p class="no-data">No resources available.</p>'}catch(s){console.error("Error loading resources:",s),t.innerHTML='<p class="error">Error loading resources</p>'}}async function D(n,e){const t=document.getElementById("assignmentsGraph");if(t.innerHTML="",e.length===0){t.innerHTML='<p class="no-data">No active course enrollments found.</p>';return}try{const s=f(p,"resources"),a=await h(s);if(a.exists()){const c=a.val(),d=e.map(r=>r.courseId),u=Object.values(c).filter(r=>d.includes(r.courseId)&&r.resourceType==="assignment"&&b(r.createdAt,7)),i=await Promise.all(u.map(async r=>{const m=f(p,`submissions/${r.courseId}/${n}`),E=(await h(m)).exists();return{...r,isSubmitted:E}})),o=i.filter(r=>!r.isSubmitted).length,l=i.filter(r=>r.isSubmitted).length;if(u.length>0){const r=v("Pending",o,"assignments-pending"),m=v("Submitted",l,"assignments-submitted");t.appendChild(r),t.appendChild(m);const g=document.createElement("p");g.className="summary-text",g.innerHTML=`<strong>${u.length}</strong> new assignments, <strong>${l}</strong> submitted`,t.appendChild(g)}else t.innerHTML='<p class="no-data">No new assignments this week.</p>'}else t.innerHTML='<p class="no-data">No assignments available.</p>'}catch(s){console.error("Error loading assignments:",s),t.innerHTML='<p class="error">Error loading assignments</p>'}}async function x(n,e){const t=document.getElementById("gradesGraph");if(t.innerHTML="",e.length===0){t.innerHTML='<p class="no-data">No active course enrollments found.</p>';return}try{const s=f(p,"submissions"),a=await h(s);if(a.exists()){const c=a.val(),d=e.map(i=>i.courseId);let u=[];if(Object.values(c).forEach(i=>{typeof i=="object"&&Object.values(i).forEach(o=>{o.studentId===n&&d.includes(o.courseId)&&o.grade!==void 0&&o.grade!==null&&u.push(o)})}),u.length>0){const i={};u.forEach(r=>{const m=r.courseName||"Unknown Course";i[m]||(i[m]={total:0,count:0}),i[m].total+=r.grade,i[m].count+=1}),Object.entries(i).forEach(([r,m])=>{const g=(m.total/m.count).toFixed(1),E=v(r,g,"grades","%");t.appendChild(E)});const o=u.reduce((r,m)=>r+m.grade,0)/u.length,l=document.createElement("p");l.className="summary-text",l.innerHTML=`<strong>Overall Average: ${o.toFixed(1)}%</strong> across ${u.length} submissions`,t.appendChild(l)}else t.innerHTML='<p class="no-data">No graded submissions yet.</p>'}else t.innerHTML='<p class="no-data">No grades available.</p>'}catch(s){console.error("Error loading grades:",s),t.innerHTML='<p class="error">Error loading grades</p>'}}async function k(n,e){const t=document.getElementById("calendarGraph");if(t.innerHTML="",e.length===0){t.innerHTML='<p class="no-data">No active course enrollments found.</p>';return}try{const s=f(p,"calendar_events"),a=await h(s);if(a.exists()){const c=a.val(),d=e.map(o=>o.courseId);let u=[];Object.values(c).forEach(o=>{typeof o=="object"&&Object.values(o).forEach(l=>{d.includes(l.courseId)&&A(l.date)&&u.push(l)})}),u.sort((o,l)=>new Date(o.date)-new Date(l.date));const i=u.slice(0,5);if(i.length>0){const o={};i.forEach(m=>{const g=m.courseName||"Unknown Course";o[g]=(o[g]||0)+1}),Object.entries(o).forEach(([m,g])=>{const E=v(m,g,"events");t.appendChild(E)});const l=document.createElement("p");l.className="summary-text";const r=i[0];l.innerHTML=`<strong>${i.length}</strong> upcoming events. Next: ${O(r.date)}`,t.appendChild(l)}else t.innerHTML='<p class="no-data">No upcoming events.</p>'}else t.innerHTML='<p class="no-data">No events available.</p>'}catch(s){console.error("Error loading calendar events:",s),t.innerHTML='<p class="error">Error loading events</p>'}}async function S(n){try{const e=document.getElementById("notificationBody");e.innerHTML="";const t=await j(n);t.length>0?t.forEach(s=>{const a=document.createElement("div");a.className=`notification-item ${s.type||"info"}`,a.innerHTML=`
                    <i class="fas ${s.icon||"fa-info-circle"}"></i>
                    <div>
                        <p>${s.message}</p>
                        <span>${s.time}</span>
                    </div>
                `,e.appendChild(a)}):e.innerHTML='<p class="no-data">No notifications at this time.</p>'}catch(e){console.error("Error loading notifications:",e),document.getElementById("notificationBody").innerHTML='<p class="error">Error loading notifications</p>'}}async function j(n){const e=[],t=f(p,"submissions"),s=await h(t);if(s.exists()){const a=s.val();let c=[];Object.values(a).forEach(d=>{typeof d=="object"&&Object.values(d).forEach(u=>{u.studentId===n&&u.gradedAt&&b(u.gradedAt,2)&&c.push(u)})}),c.forEach(d=>{e.push({message:`New grade received: ${d.grade}% in ${d.courseName||"Unknown Course"}`,icon:"fa-graduation-cap",type:"success",time:R(d.gradedAt)})})}return y&&e.push({message:`Welcome to Ehlanzeni Star School! You're enrolled in ${y.subjects?.length||0} subjects.`,icon:"fa-user-graduate",type:"info",time:"Just now"}),e.push({message:"Check your calendar for upcoming classes and deadlines",icon:"fa-calendar-alt",type:"warning",time:"Today"}),e.slice(0,5)}function v(n,e,t="default",s=""){const a=document.createElement("div");a.className="bar-item";let c=0;if(typeof e=="number")switch(t){case"grades":c=Math.min(e,100);break;case"resources":case"events":c=Math.min(e*20,100);break;case"assignments-pending":c=e*25;break;case"assignments-submitted":c=e*25+50;break;default:c=Math.min(e*10,100)}return a.innerHTML=`
        <span class="label">${n}</span>
        <div class="bar">
            <div class="bar-fill ${t}" style="width: ${c}%;"></div>
        </div>
        <span class="bar-value">${e}${s}</span>
    `,a}function b(n,e=7){const t=new Date(n);return(new Date-t)/(1e3*60*60*24)<=e}function A(n){return new Date(n)>=new Date}function O(n){return new Date(n).toLocaleDateString("en-ZA",{weekday:"short",month:"short",day:"numeric"})}function R(n){const e=new Date(n),s=new Date-e,a=Math.floor(s/(1e3*60)),c=Math.floor(s/(1e3*60*60)),d=Math.floor(s/(1e3*60*60*24));return a<60?`${a}m ago`:c<24?`${c}h ago`:d<7?`${d}d ago`:e.toLocaleDateString("en-ZA")}function L(){["resourcesGraph","assignmentsGraph","gradesGraph","calendarGraph"].forEach(e=>{const t=document.getElementById(e);t&&(t.innerHTML='<p class="no-data">No data available. Please check your course enrollments.</p>')})}function G(){const n=document.getElementById("logoutModal"),e=document.getElementById("confirmLogoutBtn"),t=document.getElementById("cancelLogoutBtn");document.getElementById("logoutBtn").addEventListener("click",()=>{n.style.display="flex"}),t.addEventListener("click",()=>{n.style.display="none"}),e.addEventListener("click",()=>{n.style.display="none",P()})}async function P(){try{await N(T),w("Logged out successfully!","success"),setTimeout(()=>window.location.href="../landing/login.html",1e3)}catch(n){console.error("Logout error:",n),w("Failed to logout: "+n.message,"error")}}function w(n,e="success"){const t=document.getElementById("toast");t.textContent=n,t.className=`toast ${e} show`,setTimeout(()=>t.className=`toast ${e}`,3e3)}function U(){document.getElementById("notificationPanel").classList.toggle("active")}function F(){document.getElementById("logoutModal").style.display="none"}window.toggleNotifications=U;window.hideLogoutModal=F;
